<html>
<head>
  <meta charset="utf-8">
  <title>Markerless AR Interaction</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://rawcdn.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <script>
    AFRAME.registerComponent('spin-toggle', {
      schema:{speed:{default:1}},
      init(){ this.enabled = false; },
      tick(time,dt){
        if(!this.enabled) return;
        this.el.object3D.rotation.y += (dt/1000) * this.data.speed * 2;
      }
    });
  </script>
</head>

<body style="margin:0; overflow:hidden;">

<a-scene
    id="scene"
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false">

    <a-assets timeout="20000">
        <a-asset-item id="sceneModel" src="scene.gltf"></a-asset-item>
        <audio id="music" src="Padoru.mp3" preload="auto"></audio>
    </a-assets>

    <a-entity>
        <a-camera id="mainCam" rotation-reader look-controls wasd-controls></a-camera>
    </a-entity>

    <a-entity id="model"
        gltf-model="#sceneModel"
        scale="0.01 0.01 0.01"
        position="0 1 -4"
        rotation="0 0 0"
        spin-toggle="speed:3">
    </a-entity>

    <a-sound
        id="bgm"
        src="#music"
        loop="true">
    </a-sound>

</a-scene>

<script>
  const model = document.querySelector("#model");
  const sound = document.querySelector("#bgm");
  const camera = document.querySelector("#mainCam");

  let spinning = false;
  let audioStarted = false;

  window.addEventListener("load", ()=>{
    if (AFRAME.utils.device.isMobile()) {
        camera.appendChild(model);
        model.setAttribute("position","0 0 -4");
    }
  });

  function toggleSpinMusic(){
    const comp = model.components["spin-toggle"];
    if(!comp) return;

    try{
      if (AFRAME.audioContext.state === "suspended") {
        AFRAME.audioContext.resume();
      }
    }catch(e){}

    spinning = !spinning;
    comp.enabled = spinning;

    const s = sound.components.sound;

    if (spinning){
      if(!audioStarted){
        try{ s.playSound(); audioStarted = true; }catch(e){}
      } else if(!s.isPlaying){
        try{s.playSound();}catch(e){}
      }
    } else {
      if(s.isPlaying){
        try{s.pauseSound();}catch(e){}
      }
    }
  }

  document.addEventListener("click", ()=>{
    if(!AFRAME.utils.device.isMobile()){
      toggleSpinMusic();
    }
  });

  document.addEventListener("touchstart", e=>{
    if(e.touches.length === 1){
      toggleSpinMusic();
    }
  });

  let startDist = null;
  let startZ = -4;

  function getDistance(touches){
    const dx = touches[0].clientX - touches[1].clientX;
    const dy = touches[0].clientY - touches[1].clientY;
    return Math.sqrt(dx*dx + dy*dy);
  }

  document.addEventListener("touchstart", e=>{
    if(e.touches.length === 2){
      startDist = getDistance(e.touches);
      const pos = model.getAttribute("position");
      startZ = pos.z;
    }
  });

  document.addEventListener("touchmove", e=>{
    if(e.touches.length === 2 && startDist){
      e.preventDefault();

      const newDist = getDistance(e.touches);
      const diff = (newDist - startDist) * 0.02;

      let pos = model.getAttribute("position");
      pos.z = startZ - diff;

      if(pos.z > -1) pos.z = -1;
      if(pos.z < -10) pos.z = -10;

      model.setAttribute("position", pos);
    }
  }, {passive:false});

  document.addEventListener("touchend", ()=>{
    startDist = null;
  });
</script>

</body>
</html>
